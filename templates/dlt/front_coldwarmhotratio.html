{% extends "dlt/base.html" %}

{% block css %}

{% endblock %}

{% block chart_name %}前区冷温热比走势图{% endblock %}

{% block chart_content %}
<div class="distribution-container">
    <div class="chart-header">
        <div class="trend-chart-wrapper" id="trend-chart-wrapper">
            <div class="loading" id="loading">加载数据中...</div>
            <div id="front-coldwarmhotratio-chart" style="width: 100%; min-height: 600px; display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<script>
let currentData = null;

document.addEventListener('DOMContentLoaded', function() {
    initPage();
});

function initPage() {
    loadColdwarmhotratioData();
}

function loadColdwarmhotratioData() {
    const loading = document.getElementById('loading');
    const chartContainer = document.getElementById('front-coldwarmhotratio-chart');
    
    loading.style.display = 'block';
    chartContainer.style.display = 'none';

    console.log('开始请求区间比数据（使用前区基本走势API）...');
    
    fetch('/api/v1/dlt/front-basic-trend')
        .then(response => {
            console.log('API响应状态:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API返回数据:', data);
            
            if (data.success && data.data && data.data.length > 0) {
                console.log('开始渲染冷温热比走势图...');
                currentData = data.data;
                renderColdwarmhotratioChart(data.data);
                loading.style.display = 'none';
                chartContainer.style.display = 'block';
            } else {
                console.log('没有有效数据');
                loading.innerHTML = '暂无数据';
            }
        })
        .catch(error => {
            console.error('加载数据失败:', error);
            loading.innerHTML = '加载失败: ' + error.message;
        });
}

function renderColdwarmhotratioChart(data) {
    const chartContainer = document.getElementById('front-coldwarmhotratio-chart');
    chartContainer.innerHTML = '';
    
    if (!data || data.length === 0) {
        console.log('数据为空，显示"暂无数据"');
        chartContainer.innerHTML = '<div class="no-data">暂无数据</div>';
        return;
    }
    
    // 转换数据格式
    const chartData = convertToChartFormat(data);
    console.log('转换后的图表数据:', chartData);
    
    // ✅ 使用 charts.js 的 createParamTrendChart 方法
    if (window.LotteryCharts && window.LotteryCharts.createParamTrendChart) {
        console.log('使用 createParamTrendChart 绘制冷温热比走势图');
        window.LotteryCharts.createParamTrendChart(
            chartContainer,  // 图表容器
            chartData,       // 图表数据
            'dlt',           // 彩票类型
            'front',           // 区域类型
            '冷温热比'           // 参数名称
        );
    } else {
        console.error('LotteryCharts.createParamTrendChart 不可用');
        chartContainer.innerHTML = '<div class="no-data">图表功能暂不可用</div>';
    }
}

function convertToChartFormat(apiData) {
    console.log('开始转换数据格式，数据条数:', apiData.length);
    
    const issues = [];
    const parameters = [];
    
    // ✅ 提取所有期的前区数据
    const allFrontBalls = apiData.map(item => item.front_balls || []);
    
    // ✅ 使用与前区基本走势图相同的遗漏值计算逻辑
    const actualMissedValues = calculateActualMissedValues(allFrontBalls, 33);
    
    apiData.forEach((item, index) => {
        issues.push(item.issue);
        
        const frontBalls = item.front_balls || [];
        
        // ✅ 使用与前区基本走势图相同的冷温热比计算逻辑
        const correctColdWarmHotRatio = calculateColdWarmHotRatioByActualMissed(
            frontBalls, index, actualMissedValues
        );
        
        // ✅ 对比API返回的错误值和正确值
        if (index < 3) {
            console.log(`第${index+1}期冷温热比对比:`, {
                issue: item.issue,
                front_balls: frontBalls,
                api_ratio: item.cold_warm_hot_ratio,  // API返回的错误值
                correct_ratio: correctColdWarmHotRatio  // 正确计算的冷温热比
            });
        }
        
        parameters.push({
            '冷温热比': correctColdWarmHotRatio,  // ✅ 使用正确计算的冷温热比
            'balls': frontBalls
        });
    });
    
    return {
        issues: issues,
        parameters: parameters
    };
}

/**
 * ✅ 使用与前区基本走势图相同的遗漏值计算逻辑
 * 计算实际遗漏值用于冷温热状态判断
 */
function calculateActualMissedValues(allFrontBalls, totalNumbers) {
    if (!allFrontBalls || allFrontBalls.length === 0) {
        return [];
    }
    
    const actualMissed = [];
    
    // ✅ 第一期：开出=0，未开出=18（冷号）
    const firstActual = {};
    const firstWinningNums = allFrontBalls[0] || [];
    
    for (let num = 1; num <= totalNumbers; num++) {
        if (firstWinningNums.includes(num)) {
            firstActual[num] = 0;  // 开出：遗漏0
        } else {
            firstActual[num] = 18; // 未开出：遗漏18（冷号）
        }
    }
    actualMissed.push(firstActual);
    
    // ✅ 后续期计算
    for (let currentIndex = 1; currentIndex < allFrontBalls.length; currentIndex++) {
        const rowActual = {};
        const currentWinningNums = allFrontBalls[currentIndex] || [];
        
        for (let num = 1; num <= totalNumbers; num++) {
            if (currentWinningNums.includes(num)) {
                rowActual[num] = 0;  // 本期开出：遗漏0
            } else {
                const prevActual = actualMissed[currentIndex - 1][num];
                if (prevActual === 0) {
                    rowActual[num] = 1;  // 上期开出，本期未开：遗漏1
                } else {
                    rowActual[num] = prevActual + 1;  // 连续未开：遗漏+1
                }
            }
        }
        
        actualMissed.push(rowActual);
    }
    
    return actualMissed;
}

/**
 * ✅ 使用与前区基本走势图相同的冷温热比计算逻辑
 * 基于实际遗漏值判断号码状态
 */
function calculateColdWarmHotRatioByActualMissed(frontBalls, rowIndex, actualMissedValues) {
    if (!frontBalls || frontBalls.length === 0) {
        return '0:0:0';
    }
    
    let coldCount = 0;  // 冷号计数
    let warmCount = 0;  // 温号计数
    let hotCount = 0;   // 热号计数
    
    frontBalls.forEach(ballNum => {
        // ✅ 使用上期的实际遗漏值判断当期号码状态
        const statusInfo = getBallStatusByActualMissed(ballNum, rowIndex, actualMissedValues);
        
        if (statusInfo.status === 'cold') {
            coldCount++;  // 天蓝色冷号
        } else if (statusInfo.status === 'warm') {
            warmCount++;  // 橙色温号
        } else if (statusInfo.status === 'hot') {
            hotCount++;   // 红色热号
        }
    });
    
    return `${coldCount}:${warmCount}:${hotCount}`;
}

/**
 * ✅ 使用与前区基本走势图相同的状态判断逻辑
 * 热号(0-3期)，温号(4-16期)，冷号(≥17期)
 */
function getBallStatusByActualMissed(ballNum, rowIndex, actualMissedValues) {
    if (rowIndex === 0) {
        // ✅ 第一期：如果号码未开出，遗漏值为18（冷号）
        return { status: 'cold', color: '#87CEEB' };
    }
    
    // ✅ 使用上期的实际遗漏值来判断
    if (actualMissedValues[rowIndex - 1] && actualMissedValues[rowIndex - 1][ballNum] !== undefined) {
        const previousActualMissed = actualMissedValues[rowIndex - 1][ballNum];
        
        if (previousActualMissed >= 17) {
            return { status: 'cold', color: '#87CEEB' };  // 遗漏≥17期：冷号
        } else if (previousActualMissed >= 4) {
            return { status: 'warm', color: '#FFA500' };  // 遗漏4-16期：温号
        } else {
            return { status: 'hot', color: '#f44336' };   // 遗漏0-3期：热号
        }
    } else {
        return { status: 'cold', color: '#87CEEB' };  // 默认冷号
    }
}
</script>

<style>
.distribution-container {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.trend-chart-wrapper {
    position: relative;
    overflow-x: auto;
    border: 0px solid #ddd;
    border-radius: 4px;
    min-height: 300px;
    margin-top: 1rem;
}

.loading {
    text-align: center;
    padding: 4rem;
    color: #666;
    font-size: 1.1rem;
    font-weight: 500;
}

.no-data {
    text-align: center;
    padding: 4rem;
    color: #666;
    font-size: 1.1rem;
    font-weight: 500;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .distribution-container {
        padding: 1rem;
    }
}

@media (max-width: 480px) {    
    .distribution-container {
        padding: 0.5rem;
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}