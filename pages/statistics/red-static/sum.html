<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>红球和值统计 - 双色球数据分析</title>
    <link rel="stylesheet" href="../../../../css/style.css">
</head>
<body>
    <!-- 保持原有HTML结构不变 -->
    <header>
        <h1>红球和值统计</h1>
        <p>EASY TO BUY, EASY TO WIN</p>
    </header>
    
    <nav>
        <!-- 导航结构保持不变 -->
    </nav>
    
    <main>
        <!-- 过滤控件和卡片内容保持不变 -->
    </main>
    
    <footer>
        <p>&copy; 2023 双色球数据分析系统. 保留所有权利.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../../../js/statistics.js"></script>
    <script>
        // 修改后的JavaScript代码
        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化加载状态
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = '数据加载中...';
            document.querySelector('main').prepend(loading);

            try {
                // 加载CSV数据
                const allData = await loadCSVData('/data/ssqhistory.csv');
                
                // 初始化年份筛选器
                initYearFilter(allData);
                
                // 默认显示所有数据的和值统计
                calculateSumStatistics(allData);
                
                // 筛选按钮事件
                document.getElementById('filter-button').addEventListener('click', function() {
                    const selectedYear = document.getElementById('year-filter').value;
                    const filteredData = filterDataByYear(allData, selectedYear);
                    calculateSumStatistics(filteredData);
                });
                
                // 重置按钮事件
                document.getElementById('reset-button').addEventListener('click', function() {
                    document.getElementById('year-filter').value = 'all';
                    calculateSumStatistics(allData);
                });

            } catch (error) {
                console.error('数据加载失败:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error';
                errorMsg.textContent = '数据加载失败，请检查数据文件路径';
                document.querySelector('main').prepend(errorMsg);
            } finally {
                loading.remove();
            }

            // 优化后的统计计算函数
            function calculateSumStatistics(data) {
                // 和值范围定义保持不变... 
                
                // 增加数据校验
                if (!data || data.length === 0) {
                    console.warn('没有可用于统计的数据');
                    return;
                }

                // 优化间隔计算逻辑
                const lastPeriodMap = new Map();
                data.forEach((item, index) => {
                    try {
                        const redBalls = item.red_balls.split(' ').map(Number);
                        const sum = redBalls.reduce((a, b) => a + b, 0);
                        
                        const range = sumRanges.find(r => sum >= r.min && sum <= r.max);
                        if (range) {
                            const stat = statistics[range.label];
                            stat.count++;
                            
                            // 优化间隔计算
                            if (lastPeriodMap.has(range.label)) {
                                const gap = index - lastPeriodMap.get(range.label);
                                stat.gaps.push(gap);
                                stat.maxGap = Math.max(stat.maxGap, gap);
                            }
                            lastPeriodMap.set(range.label, index);
                            stat.currentGap = data.length - 1 - index;
                        }
                    } catch (e) {
                        console.warn('无效数据行:', item);
                    }
                });

                // 其余计算逻辑保持不变...
            }

            // 图表渲染优化
            function renderSumChart(labels, counts, frequencies) {
                // 增加画布重置逻辑
                const canvas = document.getElementById('sum-chart');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // 图表配置优化...
            }
        });
    </script>
</body>
</html>